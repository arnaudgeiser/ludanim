
(ns ludexploit-cj.data-access
	(:require [clojure.java.jdbc :as j]
						[clojure.set :refer :all]
						[cheshire.core :refer [generate-string]]
						[php_clj.core :refer [php->clj clj->php]]
						[ludexploit-cj.config :refer [config]]))

(def mysql-db (:db config))

(defn has-booking-meta? [event] (not (empty? (:booking_meta event))))

(defn convert-booking-meta [event]
	(if (has-booking-meta? event) (php->clj (:booking_meta event)) {} ))

(defn booking-meta-to-attendees [booking-meta]
    (let [attendees (flatten (vals (get booking-meta "attendees")))]
    (map #(get % "attendee_name") attendees)))

(defn booking-meta-to-username [booking-meta]
    (let [registration (get booking-meta "registration")]
    (get registration "user_name")))

(defn booking-meta-to-email [booking-meta]
  (let [registration (get booking-meta "registration")]
    (get registration "user_email")))

(defn booking-meta-to-data [booking-meta]
  (do {:username (booking-meta-to-username booking-meta)
   ;:user_email (booking-meta-to-email booking-meta)
   :attendees (booking-meta-to-attendees booking-meta)}))

(defn convert-booking-meta-from-event [event]
  (->> event
    (convert-booking-meta)
    (booking-meta-to-data)
    (merge event)))

(defn convert-booking-meta-from-events [events]
  (map convert-booking-meta-from-event events))

(defn readable-events [events]
  (->> events
    (map #(assoc % :hasinscriptions (= (:meta_value %) "1")))
    (convert-booking-meta-from-events)))

(defn grouped [events]
	    (for [e (group-by #(select-keys % [:id :event_end_date  :event_start_date :event_name :start_time :end_time :post_content :ticket_spaces :meta_value :hasinscriptions]) events)
	        :let [
								[root-event grouped-events] e
								has-attendees (not (empty? (flatten (map #(:attendees %) (val e)))))
								categories (mapcat (fn [e] [(:category e)]) grouped-events)
	              more {:reservations (map #(assoc {} :attendees (:attendees %) :user_email (:user_email %) :username (:username %) :id (:booking_id %)) grouped-events)}
								participants (count (flatten more))]]
	        (if has-attendees (merge root-event (assoc more :categories categories :participants participants :is_full false)) (assoc root-event :reservations [] :categories categories :is_full false :participants participants))))

(defn search-events-by-festival [idFestival]
	(-> (j/query mysql-db ["select  wp_em_events.event_id as id,
																	wp_posts.post_content as post_content,
																	wp_em_bookings.booking_id,
																	event_name,
																	event_start_date,
																	event_end_date,
																	event_start_time as start_time,
																	event_end_time as end_time,
																	event_spaces,
																	ticket_spaces,
																	meta_value,
																	booking_meta,
																	wp_terms.name as category
										from wp_em_events
										join wp_posts on wp_posts.id=wp_em_events.post_id
										join wp_em_tickets on wp_em_tickets.event_id=wp_em_events.event_id
										left join wp_em_bookings on wp_em_events.event_id=wp_em_bookings.event_id
										left outer join wp_postmeta as insmeta on insmeta.post_id=wp_posts.id and insmeta.meta_key='inscription_mode'
										left outer join wp_users on wp_em_bookings.person_id=wp_users.id
										left outer join wp_term_relationships on wp_term_relationships.object_id=wp_posts.id
										left outer join wp_term_taxonomy on wp_term_taxonomy.term_taxonomy_id=wp_term_relationships.term_taxonomy_id
										left outer join wp_terms on wp_terms.term_id=wp_term_taxonomy.term_id
										join (select distinct wp_em_events.event_id from wp_em_events
													join wp_em_tickets on wp_em_events.event_id=wp_em_tickets.event_id
													left outer join wp_em_locations on wp_em_events.location_id=wp_em_locations.location_id
													join wp_postmeta on wp_postmeta.post_id=wp_em_events.post_id
													join wp_postmeta as meta2 on meta2.post_id=wp_em_events.post_id
													where wp_postmeta.meta_value=? and wp_postmeta.meta_key='festival_id') b
										on b.event_id=wp_em_events.event_id
										order by event_name" idFestival])
		(readable-events)
		(grouped)))

(defn search-events-by-festival-user [idFestival idUser]
			(-> (j/query mysql-db ["select  wp_em_events.event_id as id, wp_posts.post_content as post_content, wp_em_bookings.booking_id, event_name ,event_start_date ,event_end_date ,event_spaces ,ticket_spaces
												from wp_em_events
												join wp_posts on wp_posts.id=wp_em_events.post_id
												join wp_em_tickets on wp_em_tickets.event_id=wp_em_events.event_id
												left join wp_em_bookings on wp_em_events.event_id=wp_em_bookings.event_id
												left outer join wp_postmeta as insmeta on insmeta.post_id=wp_posts.id and insmeta.meta_key='inscription_mode'
												left outer join wp_users on wp_em_bookings.person_id=wp_users.id
												join (select distinct wp_em_events.event_id from wp_em_events
															join wp_em_tickets on wp_em_events.event_id=wp_em_tickets.event_id
															left outer join wp_em_locations on wp_em_events.location_id=wp_em_locations.location_id
															join wp_postmeta on wp_postmeta.post_id=wp_em_events.post_id
															join wp_postmeta as meta2 on meta2.post_id=wp_em_events.post_id
															where wp_postmeta.meta_value=? and wp_postmeta.meta_key='festival_id') b
												on b.event_id=wp_em_events.event_id
												where wp_users.id=?
												order by event_name" idFestival idUser])
				(readable-events)
				(grouped)))

(defn search-events []
  (-> (j/query mysql-db ["select wp_em_events.event_id as id, wp_em_bookings.booking_id, event_name ,event_start_date ,event_end_date ,event_spaces ,ticket_spaces,meta_value, booking_meta, user_email
                    from wp_em_events
                    join wp_posts on wp_posts.id=wp_em_events.post_id
                    join wp_em_tickets on wp_em_tickets.event_id=wp_em_events.event_id
                    left join wp_em_bookings on wp_em_events.event_id=wp_em_bookings.event_id
                    left outer join wp_postmeta as insmeta on insmeta.post_id=wp_posts.id and insmeta.meta_key='inscription_mode'
                    left outer join wp_users on wp_em_bookings.person_id=wp_users.id
                    join (select distinct wp_em_events.event_id from wp_em_events
                          join wp_em_tickets on wp_em_events.event_id=wp_em_tickets.event_id
                          left outer join wp_em_locations on wp_em_events.location_id=wp_em_locations.location_id
                          join wp_postmeta as meta2 on meta2.post_id=wp_em_events.post_id) b
                    on b.event_id=wp_em_events.event_id
                    order by event_name"])
		(readable-events)
		(grouped)))

(defn search-events-by-date [date]
  (-> (j/query mysql-db ["select  wp_em_events.event_id as id, wp_em_bookings.booking_id, event_name ,event_start_date ,event_end_date ,event_spaces ,ticket_spaces,meta_value, booking_meta, user_email
                    from wp_em_events
                    join wp_posts on wp_posts.id=wp_em_events.post_id
                    join wp_em_tickets on wp_em_tickets.event_id=wp_em_events.event_id
                    left join wp_em_bookings on wp_em_events.event_id=wp_em_bookings.event_id
                    left outer join wp_postmeta as insmeta on insmeta.post_id=wp_posts.id and insmeta.meta_key='inscription_mode'
                    left outer join wp_users on wp_em_bookings.person_id=wp_users.id
                    join (select distinct wp_em_events.event_id from wp_em_events
                          join wp_em_tickets on wp_em_events.event_id=wp_em_tickets.event_id
                          left outer join wp_em_locations on wp_em_events.location_id=wp_em_locations.location_id
                          join wp_postmeta as meta2 on meta2.post_id=wp_em_events.post_id) b
                    on b.event_id=wp_em_events.event_id
                    where event_start_date>=? and event_start_date<=?
                    order by event_name" date date])
										(readable-events)
										(grouped)))

(defn search-event [idEvent]
  (-> (j/query mysql-db ["select  wp_em_events.event_id as id, wp_em_bookings.booking_id, event_name ,event_start_date ,event_end_date ,event_spaces ,ticket_spaces ,meta_value, booking_meta, user_email
                    from wp_em_events
                    join wp_posts on wp_posts.id=wp_em_events.post_id
                    join wp_em_tickets on wp_em_tickets.event_id=wp_em_events.event_id
                    left join wp_em_bookings on wp_em_events.event_id=wp_em_bookings.event_id
                    left outer join wp_postmeta as insmeta on insmeta.post_id=wp_posts.id and insmeta.meta_key='inscription_mode'
                    left outer join wp_users on wp_em_bookings.person_id=wp_users.id
                    join (select distinct wp_em_events.event_id from wp_em_events
                          join wp_em_tickets on wp_em_events.event_id=wp_em_tickets.event_id
                          left outer join wp_em_locations on wp_em_events.location_id=wp_em_locations.location_id
                          join wp_postmeta as meta2 on meta2.post_id=wp_em_events.post_id) b
                    on b.event_id=wp_em_events.event_id
                    where wp_em_events.event_id=?
                    order by event_name" idEvent])
				(readable-events)
				(grouped)))

(defn search-event-raw [idEvent]
	(->> (j/query mysql-db ["select  wp_em_events.event_id as id, wp_em_bookings.booking_id, event_name ,event_start_date ,event_end_date ,event_spaces ,ticket_spaces ,meta_value, booking_meta, user_email
                    from wp_em_events
                    join wp_posts on wp_posts.id=wp_em_events.post_id
                    join wp_em_tickets on wp_em_tickets.event_id=wp_em_events.event_id
                    left join wp_em_bookings on wp_em_events.event_id=wp_em_bookings.event_id
                    left outer join wp_postmeta as insmeta on insmeta.post_id=wp_posts.id and insmeta.meta_key='inscription_mode'
                    left outer join wp_users on wp_em_bookings.person_id=wp_users.id
                    join (select distinct wp_em_events.event_id from wp_em_events
                          join wp_em_tickets on wp_em_events.event_id=wp_em_tickets.event_id
                          left outer join wp_em_locations on wp_em_events.location_id=wp_em_locations.location_id
                          join wp_postmeta as meta2 on meta2.post_id=wp_em_events.post_id) b
                    on b.event_id=wp_em_events.event_id
                    where wp_em_events.event_id=?
                    order by event_name" idEvent])
				(first)
				(convert-booking-meta)))
(defn search-user [username]
	(first (j/query mysql-db ["select * from wp_users where user_login=?" username])))

(defn search-reservations [id]
	(j/query mysql-db ["select e.event_name, b.booking_spaces from wp_em_bookings b join wp_em_events e on b.event_id=b.event_id where person_id=?" id]))

(defn search-places []
	(j/query mysql-db "select location_id as id, location_name as name, location_address as address, location_town as city, location_postcode as npa, location_latitude as latitude, location_longitude as longitude from wp_em_locations"))

(defn create-game [we]
	(j/execute! mysql-db ["insert into games (owner,name,nb_players,players) values (?,?,?,?)" "2" "One game to rule them all" "4" "Nothing..."]))

(defn search-games []
	(j/query mysql-db "select id, name, nb_players, players from games"))

(defn search-game [id]
	(j/query mysql-db ["select id, name, nb_players, players from games where id=?" id]))

(defn update-game [game]
	(j/execute! mysql-db ["update games set players=?" (generate-string (:players game))]))

(defn delete-game [game]
	(j/execute! mysql-db ["delete from games where id=?" (:id game)]))

(defn subscribe-to-game-as [name]
	(let [games search-games
				new-players (conj (:players games) name)]
			(assoc games :players new-players)))

(defn delete-reservation [idReservation]
	(j/execute! mysql-db ["delete from wp_em_bookings where booking_id=?" idReservation]))

(defn convert-to-booking-meta [reservation]
	(let [attendees [{"attendee_name" (:name reservation)}]
				booking-meta {"attendees" {"1" attendees}}]
				(clj->php booking-meta)))

(defn create-reservation [{:keys [reservation event_id]}]
	(let [current-date (java.util.Date.)
			 booking-meta (convert-to-booking-meta reservation)]
		(j/execute! mysql-db ["insert into wp_em_bookings
													(event_id, person_id, booking_spaces, booking_date, booking_status, booking_meta)
													values
													(?,0,1,?,1,?)" event_id current-date booking-meta])))


(defn festivals-to-domain [festivals]
		(map #(rename-keys % {:post_title :name}) festivals))

(defn search-festivals []
		(-> (j/query mysql-db "select post_title, ID from wp_posts where post_type='festival'and post_status='publish'")
		(festivals-to-domain)))
